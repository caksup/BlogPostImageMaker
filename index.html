<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title>Blog Post Image Maker</title>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>

</head>

<body>
    <heder>
        <h2>Simple Blog Post Image Maker</h2>
        <p><a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fjotasic.github.io%2FBlogPostImageMaker%2F&count_bg=%2379C83D&title_bg=%23555555&icon=github.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>
        </p>
    </heder>
    <br />

    <!-- text 설정 부분 -->
    <div class="textContentsArea" id="textContentsArea">
        <strong>Text:</strong></br>
        <textarea id="textContents" rows="5" cols="100">Today, I Learned 🤔</textarea>
    </div>
    <br />

    <!-- 이미지 size 및 백그라운드 컬러 설정-->
    <div class="imageOptionArea" id="imageOptionArea">
        <label for="imageWidth">Width:</label>
        <input type="number" id="imageWidth" value="700"> &nbsp;&nbsp;

        <label for="imageHeight">Height:</label>
        <input type="number" id="imageHeight" value="350"> &nbsp;&nbsp;

        <label for="imageColor">Background:</label>
        <input type="color" id="imageColor" value="#00C800"></br>

    </div>
    <br />

    <!-- 폰트 관련 설정 부분 -->
    <div class="fontOptionArea" id="fontOptionArea">
        <label for="fontSize">Font Size:</label>
        <input type="number" id="fontSize" value="40"> &nbsp;&nbsp;

        <label for="fontColor">Font Color:</label>
        <input type="color" id="fontColor" value="#FFFFFF">
    </div>
    <br />

    <!-- 미리보기 -->
    <div class="previewArea" id="previewArea">
        <strong>Preview:</strong></br>
        <svg xmlns=http://www.w3.org/2000/svg xmlns:xlink="http://www.w3.org/1999/xlink" id="imagePreview" height="200"
            width="400">

            <rect width="100%" height="100%" fill="#ffffff" id="imageBackground" />


            <text id="imageText" dominant-baseline="middle" text-anchor="middle">
            </text>
            This browser doesn't support svg 🙅‍♂️
        </svg>
        </br>

        <button onclick="downloadImage()">Download</button>
        <button onclick="copyImageToClipboard()">Copy</button>
    </div>
    <br />

    <footer>
        <a href="https://github.com/jotasic/BlogPostImageMaker/">Code</a> • Made by <a
            href="https://velog.io/@burnkim61">taewoo kim</a> • Powered By <a href="https://github.com">Github</a>
    </footer>
</body>

</html>


<script type="application/javascript">
    const imageWidth = document.getElementById('imageWidth');
    const imageHeight = document.getElementById('imageHeight');
    const imageColor = document.getElementById('imageColor');
    const contents = document.getElementById('textContents');

    const fontSize = document.getElementById('fontSize');
    const fontColor = document.getElementById('fontColor');


    // 값이 변경시 updateValue 함수 호출 하도록 설정
    imageWidth.addEventListener("change", updateValue);
    imageHeight.addEventListener("change", updateValue);
    imageColor.addEventListener("change", updateValue);
    contents.addEventListener("change", updateValue);
    fontSize.addEventListener("change", updateValue);
    fontColor.addEventListener("change", updateValue);

    // 이벤트 함수
    function updateValue(e) {
        drawCanvas();
    }

    // 페이지가 로드시 실행
    window.onload = function () {

        drawCanvas();
    }


    function drawCanvas() {
        var w = imageWidth.value;
        var h = imageHeight.value;
        var c = contents.value;

        // Image View 설정
        // id가 imagePreview SVG로 변환한다.
        var imagePreview = SVG("#imagePreview");
        imagePreview.size(w, h);

        //Text Style 설정
        // id가 imageBackground SVG로 변환한다.
        var imageBackground = SVG("#imageBackground");
        imageBackground.fill(imageColor.value);

        // font 설정
        // id가 imageText를 SVG로 변환한다.
        var imageText = SVG("#imageText");
        imageText.font("weight", "bold");
        imageText.font("size", fontSize.value);
        imageText.fill(fontColor.value);


        fillTextLine(imageText, c, w / 2, h / 2);

    }

    function fillTextLine(el, text, x, y) {

        var lines = text.split("\n");
        var lineCount = lines.length;
        var fontSize = el.font("size");

        // 여려줄일 시, 시작(맨 첫줄) y좌표값을 조절 하는 작업
        var offset = (lineCount - 1) * fontSize / 2;

        el.text(function (add) {
            for (var i = 0; i < lineCount; i++)
                add.tspan(lines[i]).ax(x).ay(y + i * fontSize - offset);
        });
    }



    //https://stackoverflow.com/questions/28226677/save-inline-svg-as-jpeg-png-svg
    function downloadImage() {
        convertImageAfterAction(function(canvas) {
            var imgURI = canvas
                .toDataURL('image/png')
                .replace('image/png', 'image/octet-stream');

                triggerDownload(imgURI);
        });
    }

    function triggerDownload(imgURI) {
        var evt = new MouseEvent('click', {
            view: window,
            bubbles: false,
            cancelable: true
        });

        var a = document.createElement('a');
        a.setAttribute('download', 'MY_COOL_IMAGE.png');
        a.setAttribute('href', imgURI);
        a.setAttribute('target', '_blank');

        a.dispatchEvent(evt);
    }


    function copyImageToClipboard() {
        convertImageAfterAction(function (canvas) {
            canvas.toBlob(function (blob) {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]);
            });
        });
    }


    function convertImageAfterAction(callback) {
        var svg = document.getElementById("imagePreview");
        var canvas = document.createElement("canvas");

        canvas.width = svg.getBoundingClientRect().width;
        canvas.height = svg.getBoundingClientRect().height;

        var ctx = canvas.getContext('2d');

        var data = (new XMLSerializer()).serializeToString(svg);
        var DOMURL = window.URL || window.webkitURL || window;

        var img = new Image();
        var svgBlob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
        var url = DOMURL.createObjectURL(svgBlob);

        img.onload = function () {
            ctx.drawImage(img, 0, 0);
            DOMURL.revokeObjectURL(url);
            
            callback(canvas);
        };
        img.src = url;
    }

</script>